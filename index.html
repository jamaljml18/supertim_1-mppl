<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>xtUML to C# Converter</title>
    <link rel="stylesheet" href="./css/style.css" />
  </head>
  <body>
    <nav class="navbar">
      <div class="logo">xtUML Tools</div>
    </nav>

    <div class="convert-section">
      <div class="container">
        <h1>xtUML to C# Converter</h1>

        <div class="controls">
          <input type="file" id="fileInput" accept=".json" />
          <button class="translate-btn" onclick="translateJson()">
            Translate JSON
          </button>
        </div>

        <div class="preview-container">
          <div class="preview-box">
            <h2>
              JSON Input
              <small
                style="font-size: 0.7em; opacity: 0.7; text-transform: none"
                >(Read Only)</small
              >
            </h2>
            <pre id="jsonPreview">// JSON content will appear here...</pre>
          </div>
          <div class="preview-box">
            <h2>
              C# Output
              <small
                style="font-size: 0.7em; opacity: 0.7; text-transform: none"
                >(Generated)</small
              >
            </h2>
            <pre id="csharpPreview">// C# code will appear here...</pre>
          </div>
        </div>
      </div>
    </div>

    <script src="./js/eventsHandling_4.js"></script>
    <script>
      const forbiddenNames = new Set([
        "class",
        "namespace",
        "using",
        "public",
        "private",
        "protected",
        "static",
        "void",
        "int",
        "string",
        "bool",
        "double",
        "float",
        "object",
        "base",
        "this",
        "if",
        "else",
        "for",
        "foreach",
        "while",
        "return",
      ]);

      function isValidIdentifier(name) {
        if (!name || typeof name !== "string") return false;
        // Cek apakah ada di daftar kata terlarang
        if (forbiddenNames.has(name.toLowerCase())) return false;
        // Cek aturan penamaan: harus diawali huruf/_ dan hanya berisi alfanumerik/_
        return /^[a-zA-Z_][a-zA-Z0-9_]*$/.test(name);
      }

      function translateJson() {
        const fileInput = document.getElementById("fileInput");
        const jsonPreview = document.getElementById("jsonPreview");
        const csharpPreview = document.getElementById("csharpPreview");

        if (fileInput.files.length === 0) {
          alert("Please select a JSON file.");
          return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function (event) {
          try {
            const json = JSON.parse(event.target.result);
            jsonPreview.textContent = JSON.stringify(json, null, 2);

            let csharpCode = `using System;\nusing System.Collections.Generic;\n\n`;

            // Bungkus dalam Namespace berdasarkan sub_name
            const namespaceName = isValidIdentifier(json.sub_name)
              ? json.sub_name
              : "GeneratedSubsystem";
            csharpCode += `namespace ${namespaceName} {\n`;

            // --- PROSES MODEL ---
            json.model.forEach((model) => {
              if (model.type === "class") {
                // VALIDASI NAMA KELAS
                if (!isValidIdentifier(model.class_name)) {
                  throw new Error(
                    `Invalid or Forbidden class name: "${model.class_name}"`
                  );
                }

                csharpCode += `    public class ${model.class_name} {\n`;

                // 1. Attributes
                if (model.attributes) {
                  model.attributes.forEach((attr) => {
                    if (!isValidIdentifier(attr.attribute_name)) {
                      throw new Error(
                        `Invalid attribute name: "${attr.attribute_name}" in class ${model.class_name}`
                      );
                    }
                    let csharpType = getCSharpType(attr.data_type);
                    csharpCode += `        public ${csharpType} ${attr.attribute_name} { get; set; }\n`;
                  });
                }

                // 2. States & Actions
                if (model.states) {
                  csharpCode += `\n        // --- States ---\n`;
                  model.states.forEach((state) => {
                    const stateClassName = state.state_name.replace(/\s/g, "_");
                    csharpCode += `        public class State_${stateClassName} {\n`;
                    csharpCode += `            public string StateId { get; } = "${state.state_id}";\n`;
                    csharpCode += `            public void ExecuteAction(${model.class_name} self) {\n`;

                    if (state.action_oal) {
                      // Contoh sederhana membersihkan OAL menjadi komentar C#
                      const lines = state.action_oal.split("\n");
                      lines.forEach((line) => {
                        csharpCode += `                // ${line}\n`;
                      });
                    }

                    csharpCode += `            }\n        }\n`;
                  });
                }
                csharpCode += `    }\n\n`;
              }

              // 3. Handle Associations (R1, R2, dst)
              else if (model.type === "association") {
                csharpCode += `    // Association ${model.name}\n`;
                // Logika relasi bisa ditambahkan di sini untuk membuat properti antar kelas
              }
            });

            csharpCode += `}`; // Tutup Namespace
            csharpPreview.textContent = csharpCode;
          } catch (error) {
            csharpPreview.textContent = "COMPILATION ERROR:\n" + error.message;
            console.error(error);
          }
        };
        reader.readAsText(file);
      }
    </script>
  </body>
</html>
