<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>xtUML to C# Converter</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <nav class="navbar">
      <div class="logo">xtUML Tools</div>
    </nav>

    <div class="convert-section">
      <div class="container">
        <h1>xtUML to C# Converter</h1>

        <div class="controls">
          <input type="file" id="fileInput" accept=".json" />
          <button class="translate-btn" onclick="translateJson()">
            Translate JSON
          </button>
        </div>

        <div class="preview-container">
          <div class="preview-box">
            <h2>
              JSON Input
              <small
                style="font-size: 0.7em; opacity: 0.7; text-transform: none"
                >(Read Only)</small
              >
            </h2>
            <pre id="jsonPreview">// JSON content will appear here...</pre>
          </div>
          <div class="preview-box">
            <h2>
              C# Output
              <small
                style="font-size: 0.7em; opacity: 0.7; text-transform: none"
                >(Generated)</small
              >
            </h2>
            <pre id="csharpPreview">// C# code will appear here...</pre>
          </div>
        </div>
      </div>
    </div>

    <script src="eventsHandling_4.js"></script>
    <script>
      function translateJson() {
        const fileInput = document.getElementById("fileInput");
        const jsonPreview = document.getElementById("jsonPreview");
        const csharpPreview = document.getElementById("csharpPreview");

        if (fileInput.files.length === 0) {
          alert("Please select a JSON file.");
          return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function (event) {
          try {
            const json = JSON.parse(event.target.result);
            jsonPreview.textContent = JSON.stringify(json, null, 2);

            let csharpCode =
              "using System;\nusing System.Collections.Generic;\n\n";

            // --- LOOP MODEL ---
            json.model.forEach((model) => {
              if (model.type === "class") {
                csharpCode += `public class ${model.class_name} {\n`;

                // 1. Attributes
                if (model.attributes) {
                  model.attributes.forEach((attr) => {
                    let csharpType = getCSharpType(attr.data_type);
                    csharpCode += `    public ${csharpType} ${attr.attribute_name} { get; set; }\n`;
                  });
                }

                // 2. States & Actions
                if (model.states) {
                  csharpCode += `\n    // --- States & Action Logic ---\n`;
                  model.states.forEach((state) => {
                    csharpCode += `    public class State_${state.state_name.replace(
                      /\s/g,
                      "_"
                    )} {\n`;
                    csharpCode += `        public string StateId { get; } = "${state.state_id}";\n`;
                    csharpCode += `\n        // Action saat memasuki state: ${state.state_name}\n`;
                    csharpCode += `        public void ExecuteAction(${model.class_name} self, dynamic eventArgs) {\n`;

                    if (state.action_oal) {
                      // Check for EventCompiler
                      if (typeof EventCompiler !== "undefined") {
                        const compiledAction = EventCompiler.compileAction(
                          state.action_oal
                        );
                        const indentedCode = compiledAction
                          .split("\n")
                          .map((line) => `            ${line}`)
                          .join("\n");
                        csharpCode += indentedCode;
                      } else {
                        // Fallback simplicity for display
                        csharpCode += `            /* ${state.action_oal} */\n`;
                      }
                    } else {
                      csharpCode += `            // No Action OAL defined.\n`;
                    }

                    csharpCode += `\n        }\n`;
                    csharpCode += `    }\n`;
                  });
                }

                csharpCode += "}\n\n";
              }

              // 2. HANDLER UNTUK FUNCTIONS (BARU)
              else if (model.type === "function") {
                // Konversi tipe return
                let returnType = "void";
                if (model.return_type) {
                    returnType = getCSharpType(model.return_type);
                }

                // Konversi Parameter (misal: "num: integer")
                let paramString = "";
                if (model.parameters && model.parameters.length > 0) {
                    paramString = model.parameters.map(p => {
                        return `${getCSharpType(p.data_type)} ${p.name}`;
                    }).join(", ");
                }

                // Tulis Header Fungsi C#
                csharpCode += `public static ${returnType} ${model.name}(${paramString}) {\n`;

                // Tulis Body Fungsi (Gunakan EventCompiler yang sudah ada!)
                if (model.action_oal) {
                    if (typeof EventCompiler !== "undefined") {
                        const compiledAction = EventCompiler.compileAction(model.action_oal);
                        // Indentasi agar rapi
                        const indentedCode = compiledAction
                          .split("\n")
                          .map((line) => `    ${line}`)
                          .join("\n");
                        csharpCode += indentedCode;
                    } else {
                        csharpCode += `    /* ${model.action_oal} */\n`;
                    }
                }

                csharpCode += "}\n\n";
              }

              // Handle Associations
              else if (model.type === "association") {
                csharpCode += `public class ${model.name} { /* Association Logic */ }\n\n`;
              } else if (model.type === "association_class") {
                csharpCode += `public class ${model.class_name} { /* Assoc Class Logic */ }\n\n`;
              }
            });

            csharpPreview.textContent = csharpCode;
          } catch (error) {
            console.error(error);
            jsonPreview.textContent = "Invalid xtUML JSON format";
            csharpPreview.textContent = "Error: " + error.message;
          }
        };

        reader.readAsText(file);
      }

      function getCSharpType(xtUmlType) {
        switch (xtUmlType) {
          case "id":
            return "int";
          case "string":
            return "string";
          case "integer":
            return "int";
          case "real":
            return "double";
          case "state":
            return "string";
          case "boolean":
            return "bool";
          case "void":
            return "void";
          default:
            return "object";
        }
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>xtUML to C# Converter</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <nav class="navbar">
      <div class="logo">xtUML Tools</div>
    </nav>

    <div class="convert-section">
      <div class="container">
        <h1>xtUML to C# Converter</h1>

        <div class="controls">
          <input type="file" id="fileInput" accept=".json" />
          <button class="translate-btn" onclick="translateJson()">
            Translate JSON
          </button>
        </div>

        <div class="preview-container">
          <div class="preview-box">
            <h2>
              JSON Input
              <small
                style="font-size: 0.7em; opacity: 0.7; text-transform: none"
                >(Read Only)</small
              >
            </h2>
            <pre id="jsonPreview">// JSON content will appear here...</pre>
          </div>
          <div class="preview-box">
            <h2>
              C# Output
              <small
                style="font-size: 0.7em; opacity: 0.7; text-transform: none"
                >(Generated)</small
              >
            </h2>
            <pre id="csharpPreview">// C# code will appear here...</pre>
          </div>
        </div>
      </div>
    </div>

    <script src="eventsHandling_4.js"></script>
    <script>
      function translateJson() {
        const fileInput = document.getElementById("fileInput");
        const jsonPreview = document.getElementById("jsonPreview");
        const csharpPreview = document.getElementById("csharpPreview");

        if (fileInput.files.length === 0) {
          alert("Please select a JSON file.");
          return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function (event) {
          try {
            const json = JSON.parse(event.target.result);
            jsonPreview.textContent = JSON.stringify(json, null, 2);

            let csharpCode =
              "using System;\nusing System.Collections.Generic;\n\n";

            // --- LOOP MODEL ---
            json.model.forEach((model) => {
              if (model.type === "class") {
                csharpCode += `public class ${model.class_name} {\n`;

                // 1. Attributes
                if (model.attributes) {
                  model.attributes.forEach((attr) => {
                    let csharpType = getCSharpType(attr.data_type);
                    csharpCode += `    public ${csharpType} ${attr.attribute_name} { get; set; }\n`;
                  });
                }

                // 2. States & Actions
                if (model.states) {
                  csharpCode += `\n    // --- States & Action Logic ---\n`;
                  model.states.forEach((state) => {
                    csharpCode += `    public class State_${state.state_name.replace(
                      /\s/g,
                      "_"
                    )} {\n`;
                    csharpCode += `        public string StateId { get; } = "${state.state_id}";\n`;
                    csharpCode += `\n        // Action saat memasuki state: ${state.state_name}\n`;
                    csharpCode += `        public void ExecuteAction(${model.class_name} self, dynamic eventArgs) {\n`;

                    if (state.action_oal) {
                      // Check for EventCompiler
                      if (typeof EventCompiler !== "undefined") {
                        const compiledAction = EventCompiler.compileAction(
                          state.action_oal
                        );
                        const indentedCode = compiledAction
                          .split("\n")
                          .map((line) => `            ${line}`)
                          .join("\n");
                        csharpCode += indentedCode;
                      } else {
                        // Fallback simplicity for display
                        csharpCode += `            /* ${state.action_oal} */\n`;
                      }
                    } else {
                      csharpCode += `            // No Action OAL defined.\n`;
                    }

                    csharpCode += `\n        }\n`;
                    csharpCode += `    }\n`;
                  });
                }

                csharpCode += "}\n\n";
              }

              // 2. HANDLER UNTUK FUNCTIONS (BARU)
              else if (model.type === "function") {
                // Konversi tipe return
                let returnType = "void";
                if (model.return_type) {
                    returnType = getCSharpType(model.return_type);
                }

                // Konversi Parameter (misal: "num: integer")
                let paramString = "";
                if (model.parameters && model.parameters.length > 0) {
                    paramString = model.parameters.map(p => {
                        return `${getCSharpType(p.data_type)} ${p.name}`;
                    }).join(", ");
                }

                // Tulis Header Fungsi C#
                csharpCode += `public static ${returnType} ${model.name}(${paramString}) {\n`;

                // Tulis Body Fungsi (Gunakan EventCompiler yang sudah ada!)
                if (model.action_oal) {
                    if (typeof EventCompiler !== "undefined") {
                        const compiledAction = EventCompiler.compileAction(model.action_oal);
                        // Indentasi agar rapi
                        const indentedCode = compiledAction
                          .split("\n")
                          .map((line) => `    ${line}`)
                          .join("\n");
                        csharpCode += indentedCode;
                    } else {
                        csharpCode += `    /* ${model.action_oal} */\n`;
                    }
                }

                csharpCode += "}\n\n";
              }

              // Handle Associations
              else if (model.type === "association") {
                csharpCode += `public class ${model.name} { /* Association Logic */ }\n\n`;
              } else if (model.type === "association_class") {
                csharpCode += `public class ${model.class_name} { /* Assoc Class Logic */ }\n\n`;
              }
            });

            csharpPreview.textContent = csharpCode;
          } catch (error) {
            console.error(error);
            jsonPreview.textContent = "Invalid xtUML JSON format";
            csharpPreview.textContent = "Error: " + error.message;
          }
        };

        reader.readAsText(file);
      }

      function getCSharpType(xtUmlType) {
        switch (xtUmlType) {
          case "id":
            return "int";
          case "string":
            return "string";
          case "integer":
            return "int";
          case "real":
            return "double";
          case "state":
            return "string";
          case "boolean":
            return "bool";
          case "void":
            return "void";
          default:
            return "object";
        }
      }
    </script>
  </body>
</html>
